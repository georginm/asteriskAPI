import BadRequestException from 'App/Exceptions/BadRequestException'
import InternalServerErrorException from 'App/Exceptions/InternalServerErrorException'
import EndpointRepository from 'App/Repositories/EndpointRepository'
import { destroy, exists, unique } from 'App/utils/database/'
import { pagination } from 'App/utils/pagination'

export default class EndpointService {
  public async create(data: any): Promise<EndpointRepository> {
    await unique(EndpointRepository.table, 'id', data.id, 'id')
    await unique(EndpointRepository.table, 'auth', data.auth, 'id')
    await unique(EndpointRepository.table, 'aors', data.aors, 'id')
    await unique(EndpointRepository.table, 'mac_address', data.macAddress, 'id')

    await exists('ps_auths', 'id', data.auth, 'id')
    await exists('ps_aors', 'id', data.aors, 'id')

    try {
      return await EndpointRepository.create(data)
    } catch (error) {
      throw new InternalServerErrorException(error.message)
    }
  }

  public async update(
    data: any,
    id: string
  ): Promise<EndpointRepository > {
    await exists(EndpointRepository.table, 'id', id)

    if (data.auth) await unique(EndpointRepository.table, 'auth', data.auth)
    if (data.aors) await unique(EndpointRepository.table, 'aors', data.aors)
    if (data.macAddress)
      await unique(EndpointRepository.table, 'mac_address', data.macAddress)

    if (data.auth) await exists('ps_auths', 'id', data.auth)
    if (data.aors) await exists('ps_aors', 'id', data.aors)

    try {
      const item = await EndpointRepository.findOrFail(id)
      return await item.merge(data).save()
    } catch (error) {
      throw new InternalServerErrorException(error.message)
    }
  }

  public async destroy(id: string): Promise<boolean> {
    return await destroy(EndpointRepository.table, 'id', id)
  }

  public async show(data: string, page: number): Promise<EndpointRepository[]> {
    const limit = pagination()
    const item = await EndpointRepository.show(data, page, limit)
    if (!item.length) throw new BadRequestException('Endpoint Not Exists')
    return item
  }

  public async index(page: number): Promise<EndpointRepository[]> {
    const limit = pagination()
    const data = await EndpointRepository.index(page, limit)
    if (!data.length) throw new BadRequestException('Endpoint Not Exists')
    return data
  }
}
